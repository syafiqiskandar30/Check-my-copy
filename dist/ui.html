<!doctype html>
<meta charset="utf-8" />
<style>
  :root {
    --bg: #fff;
    --muted: #f5f5f7;
    --line: #e6e6e6;
    --primary: #7f56d9;
    --text: #111827;
    --subtle: #6b7280;
    --chip-bg: #fff;
    --chip-border: #d1d5db;
  }
  *,
  *::before,
  *::after {
    box-sizing: border-box;
  }
  html,
  body {
    font: 14px/1.4 "Inter", system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
    margin: 0;
    width: 100%;
    max-width: 100%;
    background: var(--bg);
    color: var(--text);
    overflow-x: hidden;
  }
  .tabs {
    display: flex;
    gap: 6px;
    padding: 4px;
    margin: 12px;
    border-radius: 8px;
    background: rgba(0, 0, 0, 0.05);
  }
  .tab {
    flex: 1;
    text-align: center;
    padding: 9px 16px;
    border-radius: 8px;
    cursor: pointer;
    user-select: none;
    font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
    font-weight: 500;
    font-size: 15px;
    line-height: 18px;
    color: #788494;
    transition: color 0.15s ease, background 0.15s ease, box-shadow 0.15s ease;
  }
  .tab.active {
    background: #fff;
    color: #2d333a;
  }
  .panel {
    padding: 12px;
    display: none;
  }
  .panel.active {
    display: block;
  }
  .field-header {
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    margin-bottom: 6px;
  }
  .field-label {
    color: #525b65;
    font-size: 14px;
    line-height: 20px;
    font-weight: 500;
  }
  .tone-section {
    margin-top: 32px;
  }
  .tone-title {
    color: #525b65;
    font-size: 14px;
    line-height: 20px;
    font-weight: 500;
  }
  .tone-options {
    margin-top: 12px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  .tone-chip {
    border: 1px dashed #f5f5f5;
    border-radius: 12px;
    background: #fff;
    padding: 12px;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
    font-size: 14px;
    line-height: 17px;
    font-weight: 500;
    color: #788494;
    transition: border-color 0.15s ease, background 0.15s ease, color 0.15s ease;
  }
  .tone-chip-icon {
    width: 16px;
    height: 16px;
    display: inline-block;
    flex-shrink: 0;
  }
  .tone-chip.is-selected {
    border-style: solid;
    border-color: transparent;
    background: rgba(0, 176, 255, 0.1);
    color: #00b0ff;
  }
  .tone-chip:focus-visible {
    outline: 2px solid #00b0ff;
    outline-offset: 2px;
  }
  .tone-chip:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    border-style: dashed;
    border-color: #f5f5f5;
    background: #fff;
    color: #94a3b8;
  }
  .tone-chip:disabled .tone-chip-icon {
    opacity: 0.5;
  }
  .element-section {
    margin-top: 32px;
  }
  .element-title {
    color: #525b65;
    font-size: 14px;
    line-height: 20px;
    font-weight: 500;
  }
  .element-options {
    margin-top: 12px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  .element-chip {
    border: 1px dashed #f5f5f5;
    border-radius: 12px;
    background: #fff;
    padding: 12px 16px;
    display: flex;
    justify-content: center;
    align-items: center;
    color: #788494;
    font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
    font-size: 14px;
    line-height: 17px;
    font-weight: 500;
    cursor: pointer;
    transition: border-color 0.15s ease, background 0.15s ease, color 0.15s ease;
  }
  .element-chip.is-selected {
    border-style: solid;
    border-color: transparent;
    background: rgba(0, 176, 255, 0.1);
    color: #00b0ff;
  }
  .element-chip:focus-visible {
    outline: 2px solid #00b0ff;
    outline-offset: 2px;
  }
  textarea,
  input[type="text"] {
    width: 100%;
    padding: 12px;
    border: 1px solid #f5f5f5;
    border-radius: 4px;
    font-family: inherit;
    font-size: 14px;
    box-sizing: border-box;
    transition: border-color 0.15s ease;
  }
  textarea {
    resize: none;
    min-height: 52px;
    overflow-y: hidden;
    margin: 0;
  }
  textarea::placeholder,
  input[type="text"]::placeholder {
    color: #788494;
    line-height: 20px;
  }
  textarea:focus,
  input[type="text"]:focus {
    border-color: #00b0ff;
    outline: none;
  }
  .guideline-status {
    margin: 8px 0 0;
    font-size: 12px;
    color: var(--subtle);
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .guideline-status .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 999px;
    background: #d1d5db;
  }
  .guideline-status.loaded .status-dot {
    background: #34d399;
  }
  .guideline-status.fallback .status-dot {
    background: #fbbf24;
  }
  .guideline-status.error .status-dot {
    background: #f87171;
  }
  .chips {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 10px;
  }
  .chip-dropdown {
    position: relative;
  }
  .chip {
    border: 1px solid var(--chip-border);
    background: var(--chip-bg);
    border-radius: 999px;
    padding: 4px 12px;
    font-size: 13px;
    cursor: pointer;
  }
  .chip.is-selected {
    background: #ede9fe;
    border-color: #c4b5fd;
    color: #5b21b6;
    font-weight: 600;
  }
  .chip:focus-visible {
    outline: 2px solid var(--primary);
  }
  .rewrite-btn {
    width: 100%;
    margin-top: 12px;
    padding: 10px;
    border: 0;
    border-radius: 8px;
    background: linear-gradient(90deg, #cbd5f5, #dcd7f8);
    color: #4b5563;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
  }
  .rewrite-btn:disabled {
    cursor: default;
    opacity: 0.65;
  }
  .sparkles {
    font-size: 14px;
  }
  .suggestions {
    margin-top: 18px;
    border-top: 1px solid var(--line);
    padding-top: 12px;
  }
  .suggestions-title {
    font-weight: 600;
    margin-bottom: 10px;
  }
  .suggestion-body {
    min-height: 0;
    padding: 0;
    color: var(--subtle);
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .suggestion-body.centered {
    padding: 16px;
    min-height: 140px;
    justify-content: center;
    align-items: center;
    text-align: center;
    border-radius: 12px;
    background: var(--muted);
  }
  .suggestion-body.error {
    background: #fef2f2;
    color: #991b1b;
    border: 1px solid #fecaca;
  }
  .suggestion-body.centered .empty-arrow {
    font-size: 30px;
    color: #d1d5db;
  }
  .suggestions-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  .suggestion-card {
    border-radius: 12px;
    border: 1px solid #f1f1f3;
    background: #f8f8fa;
    padding: 12px 14px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    color: #1f2933;
  }
  .suggestion-card p {
    margin: 0;
    font-size: 14px;
  }
  .suggestion-meta {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: #6b7280;
  }
  .suggestion-char {
    color: #4b5563;
  }
  .score-pill {
    background: #d1fae5;
    color: #0f5132;
    border-radius: 6px;
    padding: 2px 8px;
    font-weight: 600;
    font-size: 12px;
  }
  .info-icon {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    border: 1px solid #d1d5db;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    color: #9ca3af;
  }
  .suggestion-footer {
    margin-top: 12px;
    text-align: center;
    font-size: 12px;
    color: #6b7280;
  }
  .suggestion-footer a {
    color: #7c3aed;
    text-decoration: none;
  }
  .suggestion-footer a:hover {
    text-decoration: underline;
  }
  .row {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .filter-row {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 24px;
  }
  .dropdown {
    position: relative;
  }
  .dropdown-trigger {
    border: 1px solid var(--chip-border);
    background: var(--chip-bg);
    border-radius: 999px;
    padding: 6px 14px;
    font-size: 13px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  .dropdown-trigger.is-selected {
    background: #ede9fe;
    border-color: #c4b5fd;
    color: #5b21b6;
    font-weight: 600;
  }
  .dropdown-trigger:focus-visible {
    outline: 2px solid var(--primary);
  }
  .dropdown-menu {
    position: absolute;
    top: calc(100% + 6px);
    left: 0;
    min-width: 220px;
    background: #fff;
    border: 1px solid #c4b5fd;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(15, 23, 42, 0.16);
    padding: 8px;
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    transform: translateY(4px);
    transition: opacity 0.15s ease, transform 0.15s ease;
    z-index: 20;
  }
  .dropdown.open .dropdown-menu {
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
    transform: translateY(0);
  }
  .tone-search {
    width: 100%;
    padding: 6px 10px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 13px;
    margin-bottom: 8px;
  }
  .dropdown-list {
    max-height: 220px;
    overflow-y: auto;
    list-style: none;
    margin: 0;
    padding: 0;
  }
  .dropdown-item {
    padding: 8px 10px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
  }
  .dropdown-item:hover,
  .dropdown-item.selected {
    background: #ede9fe;
    color: #4c1d95;
  }
  .status-text {
    margin-top: 8px;
    font-size: 12px;
    color: var(--subtle);
  }
  .muted-text {
    font-size: 12px;
    color: var(--subtle);
  }
  .context-field {
    margin-top: 12px;
  }
  .context-field label {
    display: block;
    margin-bottom: 4px;
    font-size: 13px;
    color: var(--subtle);
  }
  .context-helper,
  .custom-helper {
    margin-top: 4px;
    font-size: 14px;
    line-height: 20px;
    color: #788494;
  }
  .char-counter {
    font-size: 12px;
    line-height: 18px;
    color: #788494;
  }
  .custom-trigger .custom-clear {
    display: none;
    margin-left: 6px;
    font-size: 12px;
  }
  .custom-trigger.is-selected .custom-clear {
    display: inline;
  }
  .custom-requirements {
    margin-top: 10px;
    display: none;
    animation: fadeIn 0.15s ease;
  }
  .custom-requirements.is-visible {
    display: block;
  }
  .custom-helper {
    margin-top: 6px;
  }
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(4px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>

<div class="tabs">
  <div id="tab-rewrite" class="tab active">Rewrite</div>
  <div id="tab-settings" class="tab">Settings</div>
</div>

  <div id="panel-rewrite" class="panel active">
  <div class="field-header">
    <label class="field-label" for="inputText">Enter copy</label>
    <div id="inputCharCount" class="char-counter">0 characters</div>
  </div>
  <input
    id="inputText"
    type="text"
    placeholder="Type your copy or select a text layer in figma"
  />
  <section class="tone-section">
    <div class="tone-title">Select tone</div>
    <div id="toneOptionList" class="tone-options"></div>
  </section>
  <section class="element-section">
    <div class="element-title">Select usage</div>
    <div id="elementOptionList" class="element-options"></div>
  </section>
  <div id="filterControls" class="filter-row"></div>
  <div id="customInputWrapper" class="custom-requirements" aria-hidden="true">
    <textarea
      id="customInput"
      rows="4"
      placeholder="- Start with...
- Phrase as...
- Do not use..."
    ></textarea>
    <p class="custom-helper">Add bespoke requirements, banned words, or formatting notes.</p>
  </div>
  <div class="context-field">
    <label for="usageContextInput">where will this copy be used?</label>
    <input
      id="usageContextInput"
      type="text"
      placeholder="e.g. Push notification for failed payment"
    />
    <p class="context-helper">Helps tailor tone, urgency, and format to the exact surface.</p>
  </div>

  <button id="rewrite" class="rewrite-btn" disabled>
    <span class="sparkles">✧</span>
    Rewrite
  </button>

  <section class="suggestions">
    <div class="suggestions-title">Suggestions</div>
    <div id="suggestionBody" class="suggestion-body centered"></div>
  </section>
</div>

<div id="panel-settings" class="panel">
  <div id="guidelineStatus" class="guideline-status fallback">
    <span class="status-dot"></span>
    <span class="guideline-text">Loading style guide…</span>
  </div>
  <label>API key (Gemini)</label>
  <input id="apikey" type="text" placeholder="AIza..." />
  <div class="row">
    <button id="saveKey">Save key</button>
    <button id="loadKey">Load key</button>
  </div>
  <div id="saveStatus" style="margin-top:8px;color:#555;"></div>
</div>

<script>
  // tab switching
  const tabs = {
    rewrite: { tab: document.getElementById("tab-rewrite"), panel: document.getElementById("panel-rewrite") },
    settings:{ tab: document.getElementById("tab-settings"), panel: document.getElementById("panel-settings") },
  };
  function activate(name){
    Object.values(tabs).forEach(({tab,panel})=>{
      tab.classList.remove("active"); panel.classList.remove("active");
    });
    tabs[name].tab.classList.add("active"); tabs[name].panel.classList.add("active");
  }
  tabs.rewrite.tab.onclick=()=>activate("rewrite");
  tabs.settings.tab.onclick=()=>{
    activate("settings");
  };

  // rewrite flow
  const btnRewrite = document.getElementById("rewrite");
  const suggestionBody = document.getElementById("suggestionBody");
  const inputField = document.getElementById("inputText");
  const inputCharCounter = document.getElementById("inputCharCount");
  const MIN_SUGGESTIONS = 5;
  const toneFallbacks = [
    ["Engaging", "Friendly"],
    ["Warm", "Appreciative"],
    ["Enthusiastic", "Encouraging"],
    ["Upbeat", "Supportive"],
    ["Confident", "Empowering"],
  ];

  const geminiKeyInput = document.getElementById("apikey");
  const saveKeyBtn = document.getElementById("saveKey");
  const loadKeyBtn = document.getElementById("loadKey");
  const saveStatus = document.getElementById("saveStatus");
  const guidelineStatus = document.getElementById("guidelineStatus");
  const guidelineStatusText = guidelineStatus?.querySelector(".guideline-text");
  const filterControls = document.getElementById("filterControls");
  const customInputWrapper = document.getElementById("customInputWrapper");
  const customInput = document.getElementById("customInput");
  const usageContextInput = document.getElementById("usageContextInput");
  let customTrigger = null;
  let usageContextValue = "";
  const formatCharCount = (count) => `${count} character${count === 1 ? "" : "s"}`;
  const updateInputCharCount = () => {
    if (!inputCharCounter) return;
    const value = inputField?.value || "";
    inputCharCounter.textContent = formatCharCount(value.length);
  };

  const fallbackGuideline = Object.freeze({
    name: "Warm lower-case headings",
    instructions:
      "Write 2-6 word lower-case headings with a warm, appreciative, enthusiastic tone. Keep copy mobile friendly and avoid emojis unless explicitly requested.",
    examples: [
      "thanks for being here",
      "we love having you",
      "you're in great company",
    ],
  });

  const filterConfigs = [
    {
      key: "length",
      label: "Length",
      options: ["Short (≤40 chars)", "Medium (41-80 chars)", "Long (81+ chars)"],
    },
    {
      key: "case",
      label: "Case",
      options: ["Sentence case", "Title Case", "lowercase", "UPPERCASE"],
    },
    {
      key: "custom",
      label: "Custom",
      options: ["No contractions", "Add emoji", "Reassure user", "Add urgency"],
    },
  ];
  const filterSelections = {};
  const dropdownRefs = new Map();
  const MAX_TONE_SELECTIONS = 2;
  const elementOptionList = document.getElementById("elementOptionList");
  const getToneSelections = () => {
    const tones = filterSelections.tone;
    if (Array.isArray(tones)) return tones;
    if (typeof tones === "string" && tones.length) return [tones];
    return [];
  };
  const setToneSelections = (tones) => {
    if (!tones || !tones.length) {
      delete filterSelections.tone;
    } else {
      filterSelections.tone = tones;
    }
  };

  const toneOptionList = document.getElementById("toneOptionList");
  const TONE_ICONS = Object.freeze({
    add: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTggMTZDMTIuNDE4MyAxNiAxNiAxMi40MTgzIDE2IDhDMTYgMy41ODE3MiAxMi40MTgzIDAgOCAwQzMuNTgxNzIgMCAwIDMuNTgxNzIgMCA4QzAgMTIuNDE4MyAzLjU4MTcyIDE2IDggMTZaIiBmaWxsPSIjMDBCMEZGIi8+CjxwYXRoIGQ9Ik0xMS40Mjg3IDkuMTM4NjlDMTIuMDU5OSA5LjEzODY5IDEyLjU3MTYgOC42MjcwMSAxMi41NzE2IDcuOTk1ODNDMTIuNTcxNiA3LjM2NDY1IDEyLjA1OTkgNi44NTI5NyAxMS40Mjg3IDYuODUyOTdMOS4xNDI5MSA2Ljg1Mjk3VjQuNTY3MTdDOS4xNDI5MSAzLjkzNTk5IDguNjMxMjQgMy40MjQzMiA4LjAwMDA1IDMuNDI0MzJDNy4zNjg4NyAzLjQyNDMyIDYuODU3MiAzLjkzNTk5IDYuODU3MiA0LjU2NzE3VjYuODUyOTdINC41NzE1N0MzLjk0MDM5IDYuODUyOTcgMy40Mjg3MSA3LjM2NDY1IDMuNDI4NzEgNy45OTU4M0MzLjQyODcxIDguNjI3MDEgMy45NDAzOSA5LjEzODY5IDQuNTcxNTcgOS4xMzg2OUg2Ljg1NzJWMTEuNDI0M0M2Ljg1NzIgMTIuMDU1NSA3LjM2ODg3IDEyLjU2NzIgOC4wMDAwNSAxMi41NjcyQzguNjMxMjQgMTIuNTY3MiA5LjE0MjkxIDEyLjA1NTUgOS4xNDI5MSAxMS40MjQzVjkuMTM4NjlIMTEuNDI4N1oiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo=",
    remove: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTAgOEMwIDEyLjQxODMgMy41ODE3MiAxNiA4IDE2QzEyLjQxODMgMTYgMTYgMTIuNDE4MyAxNiA4QzE2IDMuNTgxNzIgMTIuNDE4MyAwIDggMEMzLjU4MTcyIDAgMCAzLjU4MTcyIDAgOFoiIGZpbGw9IiMwMEIwRkYiLz4KPHBhdGggZD0iTTkuNjIwNTUgMTEuMjMyNkMxMC4wNjY5IDExLjY3ODkgMTAuNzkwNSAxMS42Nzg5IDExLjIzNjggMTEuMjMyNkMxMS42ODMxIDEwLjc4NjMgMTEuNjgzMSAxMC4wNjI3IDExLjIzNjggOS42MTYzNkw5LjYyMDQ5IDguMDAwMDVMMTEuMjM2OCA2LjM4Mzc1QzExLjY4MzEgNS45Mzc0NCAxMS42ODMxIDUuMjEzODIgMTEuMjM2OCA0Ljc2NzVDMTAuNzkwNSA0LjMyMTE5IDEwLjA2NjkgNC4zMjExOSA5LjYyMDU1IDQuNzY3NUw4LjAwNDI1IDYuMzgzODFMNi4zODgwNyA0Ljc2NzYzQzUuOTQxNzUgNC4zMjEzMSA1LjIxODE0IDQuMzIxMzEgNC43NzE4MiA0Ljc2NzYzQzQuMzI1NTEgNS4yMTM5NCA0LjMyNTUxIDUuOTM3NTYgNC43NzE4MiA2LjM4Mzg3TDYuMzg4MDEgOC4wMDAwNUw0Ljc3MTgyIDkuNjE2MjRDNC4zMjU1MSAxMC4wNjI2IDQuMzI1NTEgMTAuNzg2MiA0Ljc3MTgyIDExLjIzMjVDNS4yMTgxNCAxMS42Nzg4IDUuOTQxNzUgMTEuNjc4OCA2LjM4ODA3IDExLjIzMjVMOC4wMDQyNSA5LjYxNjNMOS42MjA1NSAxMS4yMzI2WiIgZmlsbD0id2hpdGUiLz4KPC9zdmc+Cg==",
  });
  const toneOptions = [
    "Apologetic",
    "Casual",
    "Catchy",
    "Confident",
    "Conversational",
    "Convincing",
    "Crisp",
    "Empathetic",
    "Engaging",
    "Enthusiastic",
    "Exciting",
    "Formal",
    "Friendly",
    "Funny",
    "Happy",
    "Helpful",
    "Inclusive",
    "Informative",
    "Intelligent",
    "Inviting",
    "Kind",
    "Playful",
    "Polite",
    "Positive",
    "Professional",
    "Upbeat",
    "Warm",
    "Witty",
  ];
  const renderToneChips = () => {
    if (!toneOptionList) return;
    const selectedTones = getToneSelections();
    toneOptionList.innerHTML = toneOptions
      .map((tone) => {
        const isSelected = selectedTones.includes(tone);
        const isDisabled = !isSelected && selectedTones.length >= MAX_TONE_SELECTIONS;
        const iconSrc = isSelected ? TONE_ICONS.remove : TONE_ICONS.add;
        return `<button type="button" class="tone-chip${isSelected ? " is-selected" : ""}" data-tone="${tone}" aria-pressed="${isSelected}" ${
          isDisabled ? "disabled" : ""
        }>
          <span class="tone-chip-label">${tone}</span>
          <img class="tone-chip-icon" src="${iconSrc}" alt="" aria-hidden="true" />
        </button>`;
      })
      .join("");
  };

  toneOptionList?.addEventListener("click", (event) => {
    const chip = event.target.closest(".tone-chip");
    if (!chip) return;
    const tone = chip.getAttribute("data-tone");
    if (!tone) return;
    if (chip.disabled) return;
    const current = getToneSelections();
    if (current.includes(tone)) {
      setToneSelections(current.filter((item) => item !== tone));
    } else if (current.length < MAX_TONE_SELECTIONS) {
      setToneSelections([...current, tone]);
    }
    renderToneChips();
  });

  const elementOptions = [
    "Heading",
    "Description",
    "CTA Button",
    "Body",
    "Tooltip",
    "Empty state",
    "Toast",
    "Label",
  ];
  const renderElementChips = () => {
    if (!elementOptionList) return;
    const selected = filterSelections.element || "";
    elementOptionList.innerHTML = elementOptions
      .map(
        (element) => `<button type="button" class="element-chip${selected === element ? " is-selected" : ""}" data-element="${element}">
            ${element}
          </button>`
      )
      .join("");
  };
  elementOptionList?.addEventListener("click", (event) => {
    const chip = event.target.closest(".element-chip");
    if (!chip) return;
    const value = chip.getAttribute("data-element");
    if (!value) return;
    filterSelections.element = filterSelections.element === value ? "" : value;
    if (!filterSelections.element) {
      delete filterSelections.element;
    }
    renderElementChips();
  });

  const setGuidelineIndicator = (state, text) => {
    if (!guidelineStatus || !guidelineStatusText) return;
    guidelineStatus.classList.remove("loaded", "fallback", "error");
    guidelineStatus.classList.add(state);
    guidelineStatusText.textContent = text;
  };

  let guidelineReference = null;
  const getGuidelinePayload = () => {
    if (guidelineReference) return guidelineReference;
    setGuidelineIndicator("fallback", "Using fallback style guide.");
    return fallbackGuideline;
  };
  const buildGuidelinePayload = () => {
    const base = getGuidelinePayload();
    const payload = base && typeof base === "object" ? { ...base } : {};
    const toneSelections = getToneSelections();
    if (toneSelections.length === 1) {
      payload.tonePreference = toneSelections[0];
    } else if (toneSelections.length > 1) {
      payload.tonePreference = toneSelections;
    } else {
      delete payload.tonePreference;
    }
    const otherFilters = Object.entries(filterSelections).reduce((acc, [key, value]) => {
      if (!value || key === "tone") return acc;
      acc[key] = value;
      return acc;
    }, {});
    if (Object.keys(otherFilters).length) {
      payload.styleFilters = otherFilters;
    } else {
      delete payload.styleFilters;
    }
    if (usageContextValue) {
      payload.usageContext = usageContextValue;
    } else {
      delete payload.usageContext;
    }
    return payload;
  };
  setGuidelineIndicator("fallback", "Loading style guide…");

  const resolveTargetOrigin = () => {
    try {
      const ref = document.referrer;
      if (ref && ref !== "null") {
        return new URL(ref).origin;
      }
    } catch (err) {
      console.warn("Could not parse parent origin:", err);
    }
    return "https://www.figma.com";
  };

  const targetOrigin = resolveTargetOrigin();

  const postToPlugin = (pluginMessage) => {
    if (!window.parent || window.parent === window) {
      console.warn("Figma host unavailable; skipping postMessage", pluginMessage);
      return;
    }
    window.parent.postMessage({ pluginMessage }, targetOrigin);
  };

  const renderEmptyState = () => {
    suggestionBody.className = "suggestion-body centered";
    suggestionBody.innerHTML = `
      <div class="empty-arrow">↑</div>
      <p>Select a text layer in Figma and click Rewrite to generate copy suggestions</p>
    `;
  };

  const renderStatus = (text) => {
    suggestionBody.className = "suggestion-body centered";
    suggestionBody.innerHTML = `<p>${text}</p>`;
  };

  const renderError = (text) => {
    suggestionBody.className = "suggestion-body centered error";
    suggestionBody.innerHTML = `<p>${text || "Something went wrong. Try again in a bit."}</p>`;
  };

  const renderSuggestions = (items) => {
    if (!items.length) {
      renderStatus("No response.");
      return;
    }

    const cards = items
      .map(
        (item) => `
        <article class="suggestion-card">
          <p>${item.text}</p>
          <div class="suggestion-meta">
            <span class="score-pill">${item.score}%</span>
            <span>${item.tones.join(", ")}</span>
            <span class="suggestion-char">${formatCharCount(item.text.length)}</span>
            <span class="info-icon" title="Score confidence">i</span>
          </div>
        </article>`
      )
      .join("");

    suggestionBody.className = "suggestion-body";
    suggestionBody.innerHTML = `
      <div class="suggestions-list">${cards}</div>
      <div class="suggestion-footer">
        Suggestions aren't helpful? <a href="https://forms.gle/" target="_blank" rel="noopener">Let us know</a>
      </div>
    `;
  };

  const stripFormatting = (line) =>
    line
      .replace(/[*_`]/g, "")
      .replace(/^\d+[\.)-]*\s*/, "")
      .replace(/^[-•*]+\s*/, "")
      .replace(/\s+/g, " ")
      .trim();

  const looksLikeMeta = (line) => {
    const lower = line.toLowerCase();
    if (!lower) return true;
    if (lower.length <= 2) return true;
    const metaPrefixes = [
      "here are",
      "here's",
      "these are",
      "please note",
      "okay, i'm",
      "alright, i'm",
      "i'm ready",
      "let me",
      "i will",
      "i can",
      "remember:",
      "for reference",
      "guideline:",
      "dialog:",
      "instruction:",
    ];
    if (metaPrefixes.some((p) => lower.startsWith(p))) return true;
    if (/^option\s*\d+/i.test(lower)) return true;
    if (lower.startsWith("option ") || lower.startsWith("option:")) return true;
    if (lower.includes("option ") && lower.endsWith(":")) return true;
    if (lower.includes("dialog") || lower.includes("instruction")) return true;
    if (lower.endsWith(":") && (lower.includes("requirement") || lower.includes("suggestion"))) return true;
    if (lower.includes("i've provided") || lower.includes("i have provided")) return true;
    if (lower.includes("below are") || lower.includes("as requested")) return true;
    return false;
  };

  const expandNumberedItems = (text) => {
    if (!/\d+[\.)-]/.test(text)) return null;
    const segments = text
      .split(/\d+[\.)-]\s*/g)
      .map((segment) => segment.trim())
      .filter(Boolean);
    return segments.length >= 2 ? segments : null;
  };

  const buildSuggestions = (raw) => {
    if (!raw) return [];

    const expandedRaw = raw.replace(/(\d+[\.)-])/g, "\n$1");
    let blocks = expandedRaw.split(/\n{2,}/);
    if (blocks.length === 1) {
      blocks = expandedRaw.split(/\n+/);
    }

    const normalized = blocks
      .map((block) => stripFormatting(block))
      .filter(Boolean)
      .filter((block) => !looksLikeMeta(block));

    const flattened = normalized.flatMap((text) => {
      const expanded = expandNumberedItems(text);
      return expanded && expanded.length ? expanded : [text];
    });

    const unique = [];
    const seen = new Set();
    flattened.forEach((text) => {
      const clean = stripFormatting(text);
      if (!clean) return;
      const key = clean.toLowerCase();
      if (!seen.has(key)) {
        seen.add(key);
        unique.push(clean);
      }
    });

    return unique.slice(0, MIN_SUGGESTIONS).map((text, idx) => ({
      text,
      score: Math.max(80, 95 - idx * 2),
      tones: toneFallbacks[idx % toneFallbacks.length],
    }));
  };

  const applySelectionText = (text) => {
    if (!text) return;
    inputField.value = text;
    inputField.dispatchEvent(new Event("input"));
  };

  const renderDropdownOptions = (key, query = "") => {
    const ref = dropdownRefs.get(key);
    if (!ref) return;
    const search = query.trim().toLowerCase();
    const options = ref.config.options.filter((option) =>
      option.toLowerCase().includes(search)
    );
    if (!options.length) {
      ref.list.innerHTML = `<li class="dropdown-item" style="color:#94a3b8;cursor:default;">No matches</li>`;
      return;
    }
    ref.list.innerHTML = options
      .map(
        (option) =>
          `<li class="dropdown-item${filterSelections[key] === option ? " selected" : ""}" data-value="${option}">${option}</li>`
      )
      .join("");
  };

  const closeAllDropdowns = () => {
    dropdownRefs.forEach(({ wrapper }) => wrapper.classList.remove("open"));
  };

  const toggleDropdown = (key) => {
    const ref = dropdownRefs.get(key);
    if (!ref) return;
    const isOpen = ref.wrapper.classList.contains("open");
    closeAllDropdowns();
    if (!isOpen) {
      ref.wrapper.classList.add("open");
      if (ref.searchInput) {
        ref.searchInput.value = "";
        renderDropdownOptions(key);
        requestAnimationFrame(() => ref.searchInput?.focus());
      } else {
        renderDropdownOptions(key);
      }
    }
  };

  const createDropdowns = () => {
    if (!filterControls) return;
    filterConfigs.forEach((config) => {
      if (config.key === "custom") {
        const wrapper = document.createElement("div");
        wrapper.className = "dropdown";
        wrapper.dataset.key = config.key;

        const trigger = document.createElement("button");
        trigger.type = "button";
        trigger.className = "dropdown-trigger custom-trigger";
        trigger.innerHTML = `<span>${config.label}</span><span class="custom-clear" aria-hidden="true">×</span>`;
        wrapper.appendChild(trigger);
        filterControls.appendChild(wrapper);
        customTrigger = trigger;

        trigger.addEventListener("click", (event) => {
          event.stopPropagation();
          closeAllDropdowns();
          if (!customInputWrapper) return;
          const shouldShow = !customInputWrapper.classList.contains("is-visible");
          customInputWrapper.classList.toggle("is-visible", shouldShow);
          customInputWrapper.setAttribute("aria-hidden", shouldShow ? "false" : "true");
          if (shouldShow) {
            trigger.classList.add("is-selected");
            requestAnimationFrame(() => customInput?.focus());
          } else {
            trigger.classList.remove("is-selected");
            if (customInput) {
              customInput.value = "";
            }
            delete filterSelections.custom;
          }
        });
        return;
      }

      const wrapper = document.createElement("div");
      wrapper.className = "dropdown";
      wrapper.dataset.key = config.key;

      const trigger = document.createElement("button");
      trigger.type = "button";
      trigger.className = "dropdown-trigger";
      trigger.textContent = config.label;
      wrapper.appendChild(trigger);

      const menu = document.createElement("div");
      menu.className = "dropdown-menu";

      let searchInput = null;
      if (config.searchable) {
        searchInput = document.createElement("input");
        searchInput.type = "text";
        searchInput.placeholder = `Search ${config.label.toLowerCase()}...`;
        searchInput.className = "tone-search";
        menu.appendChild(searchInput);
      }

      const list = document.createElement("ul");
      list.className = "dropdown-list";
      menu.appendChild(list);

      wrapper.appendChild(menu);
      filterControls.appendChild(wrapper);

      dropdownRefs.set(config.key, { wrapper, trigger, menu, list, searchInput, config });

      trigger.addEventListener("click", (event) => {
        event.stopPropagation();
        toggleDropdown(config.key);
      });

      searchInput?.addEventListener("input", (event) => {
        const value = event.target.value;
        renderDropdownOptions(config.key, value);
      });

      list.addEventListener("click", (event) => {
        const target = event.target.closest(".dropdown-item");
        if (!target) return;
        const value = target.getAttribute("data-value");
        if (!value || value === "No matches") return;
        filterSelections[config.key] = value;
        trigger.textContent = value;
        trigger.classList.add("is-selected");
        renderDropdownOptions(config.key, searchInput ? searchInput.value : "");
        closeAllDropdowns();
      });
    });
  };

  createDropdowns();
  renderToneChips();
  renderElementChips();

  customInput?.addEventListener("input", () => {
    const value = customInput.value.trim();
    if (value) {
      filterSelections.custom = value;
    } else {
      delete filterSelections.custom;
    }
  });

  customInput?.addEventListener("keydown", (event) => {
    if (event.key === "Escape" && customInputWrapper?.classList.contains("is-visible")) {
      event.preventDefault();
      customTrigger?.click();
    }
  });

  usageContextInput?.addEventListener("input", () => {
    usageContextValue = usageContextInput.value.trim();
  });

  document.addEventListener("click", () => closeAllDropdowns());

  btnRewrite.onclick = async () => {
    renderStatus("Thinking...");
    const text = inputField.value.trim();
    const guidelinePayload = buildGuidelinePayload();
    if (!text) {
      alert("Please enter some text.");
      renderEmptyState();
      return;
    }

    const key = geminiKeyInput ? geminiKeyInput.value.trim() : "";
    if (!key) {
      postToPlugin({ type: "load-key" });
      renderStatus("Loading saved key...");
      window.__pendingText = text;
      window.__pendingGuideline = guidelinePayload;
      return;
    }

    delete window.__pendingGuideline;
    postToPlugin({ type: "rewrite", key, text, guideline: guidelinePayload });
  };

  inputField.addEventListener("input", () => {
    const hasText = Boolean(inputField.value.trim());
    btnRewrite.disabled = !hasText;
    updateInputCharCount();
    if (!hasText && !window.__pendingText) {
      renderEmptyState();
    }
  });

  // settings save/load
  saveKeyBtn.onclick = () => {
    const key = geminiKeyInput.value.trim();
    postToPlugin({ type: "save-key", key });
    saveStatus.textContent = "Saving…";
  };
  loadKeyBtn.onclick = () => {
    postToPlugin({ type: "load-key" });
    saveStatus.textContent = "Loading…";
  };

  // messages from main
  onmessage = (event) => {
    const msg = event.data.pluginMessage;

    if (msg?.type === "guideline-default") {
      if (msg.error) {
        guidelineReference = null;
        setGuidelineIndicator("error", "Couldn't load style guide. Using fallback.");
      } else if (msg.guideline) {
        guidelineReference = msg.guideline;
        setGuidelineIndicator("loaded", "Using structured style guide.");
      } else {
        guidelineReference = null;
        setGuidelineIndicator("fallback", "Using fallback style guide.");
      }
      return;
    }

    if (msg?.type === "key-saved") {
      saveStatus.textContent = msg.error ? ("Save failed: " + msg.error) : "Key saved.";
      if (!msg.error && typeof msg.key === "string") {
        geminiKeyInput.value = msg.key;
      }
      return;
    }
    if (msg?.type === "key-loaded") {
      if (msg.error) {
        saveStatus.textContent = "Load failed: " + msg.error;
        if (window.__pendingText) {
          renderStatus("Couldn't load your API key. Add it in Settings to try again.");
          delete window.__pendingText;
          delete window.__pendingGuideline;
          activate("settings");
        }
        return;
      }

      const loadedKeyRaw = typeof msg.key === "string" ? msg.key : "";
      const loadedKey = loadedKeyRaw.trim();

      geminiKeyInput.value = loadedKeyRaw;
      saveStatus.textContent = loadedKey ? "Key loaded." : "No key saved yet.";

      if (window.__pendingText) {
        if (loadedKey) {
          const text = window.__pendingText;
          const guide = window.__pendingGuideline || buildGuidelinePayload();
          delete window.__pendingText;
          delete window.__pendingGuideline;
          postToPlugin({ type: "rewrite", key: loadedKey, text, guideline: guide });
          renderStatus("Thinking...");
        } else {
          renderStatus("Add your Gemini API key in Settings to generate copy suggestions.");
          delete window.__pendingText;
          delete window.__pendingGuideline;
          activate("settings");
        }
      }
      return;
    }
    if (msg?.type === "error") {
      const errText =
        typeof msg.error === "string"
          ? msg.error
          : msg && msg.error && msg.error.message
          ? String(msg.error.message)
          : "Unknown error.";
      console.error("Gemini rewrite error:", msg.error);
      renderStatus("Generation failed: " + errText);
      return;
    }
    if (msg?.type === "selection-text") {
      if (typeof msg.text === "string" && msg.text.length) {
        applySelectionText(msg.text);
      }
      return;
    }
    if (msg?.type === "rewrite-done") {
      const output = typeof msg.output === "string" ? msg.output.trim() : "";
      if (msg.error) {
        renderError(output);
      } else {
        const suggestions = buildSuggestions(output);
        if (suggestions.length >= MIN_SUGGESTIONS) {
          renderSuggestions(suggestions);
        } else {
          renderError(
            suggestions.length
              ? `Only ${suggestions.length}/${MIN_SUGGESTIONS} suggestions returned. Please try again.`
              : output || "No response."
          );
        }
      }
      activate("rewrite");
      return;
    }
  };

  // auto-load key when opening settings
  tabs.settings.tab.addEventListener("click", ()=> {
    postToPlugin({ type: "load-key" });
    saveStatus.textContent = "Loading…";
  });

  updateInputCharCount();
  renderEmptyState();
  postToPlugin({ type: "request-guideline" });
</script>
